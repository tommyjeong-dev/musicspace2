// js/admin-main.js - ÌÜµÌï© Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê

document.addEventListener('DOMContentLoaded', () => {
    // --- 1. Ï†ÑÏó≠ Î≥ÄÏàò ---
    let currentTab = 'dashboard';
    let genreChart = null;
    let userChart = null;
    let systemStatusInterval = null;
    
    // ÎÖ∏Îûò Í¥ÄÎ¶¨ Í¥ÄÎ†® Î≥ÄÏàòÎì§
    let allSongs = [];
    let filteredSongs = [];
    let selectedSongs = new Set();

    // --- 2. ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù Í¥ÄÎ†® Ìï®Ïàò ---
    
    /** ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏ */
    async function checkAuthStatus() {
        try {
            const response = await fetch('/api/user', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú:', data.user.username, 'Í¥ÄÎ¶¨Ïûê:', data.user.isAdmin);
                
                // Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏïÑÎãàÎ©¥ Ï†ëÍ∑º Í±∞Î∂Ä
                if (!data.user.isAdmin) {
                    alert('Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                    window.location.href = '/index.html';
                    return;
                }
                
                // Î°úÍ∑∏Ïù∏Îêú ÏÉÅÌÉú - ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú
                const userInfoEl = document.getElementById('user-info');
                const usernameEl = document.getElementById('username');
                const userInitialEl = document.getElementById('user-initial');
                
                if (userInfoEl && usernameEl && userInitialEl) {
                    userInfoEl.style.display = 'flex';
                    usernameEl.textContent = data.user.username;
                    userInitialEl.textContent = data.user.username.charAt(0).toUpperCase();
                }
                
            } else {
                console.log('Î°úÍ∑∏Ïù∏ÎêòÏßÄ ÏïäÏùÄ ÏÉÅÌÉú');
                alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                window.location.href = '/login.html';
            }
        } catch (error) {
            console.error('Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò:', error);
            alert('Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            window.location.href = '/login.html';
        }
    }

    /** Î°úÍ∑∏ÏïÑÏõÉ Í∏∞Îä• */
    async function logout() {
        try {
            const response = await fetch('/api/logout', {
                method: 'POST',
                credentials: 'include'
            });
            
            if (response.ok) {
                console.log('Î°úÍ∑∏ÏïÑÏõÉ ÏÑ±Í≥µ');
                window.location.href = '/login.html';
            } else {
                console.error('Î°úÍ∑∏ÏïÑÏõÉ Ïã§Ìå®');
            }
        } catch (error) {
            console.error('Î°úÍ∑∏ÏïÑÏõÉ Ïò§Î•ò:', error);
        }
    }

    // --- 3. ÌÉ≠ Í¥ÄÎ¶¨ ---

    /** ÌÉ≠ Ï†ÑÌôò */
    function switchTab(tabName) {
        // Î™®Îì† ÌÉ≠ ÏΩòÌÖêÏ∏† Ïà®Í∏∞Í∏∞
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Î™®Îì† Î©îÎâ¥ ÏïÑÏù¥ÌÖú ÎπÑÌôúÏÑ±Ìôî
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
        const targetTab = document.getElementById(`${tabName}-tab`);
        const targetMenuItem = document.querySelector(`[data-tab="${tabName}"]`);
        
        if (targetTab && targetMenuItem) {
            targetTab.classList.add('active');
            targetMenuItem.classList.add('active');
            currentTab = tabName;
            
            // ÌÉ≠Î≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎî©
            loadTabData(tabName);
        }
    }

    /** ÌÉ≠Î≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎî© */
    async function loadTabData(tabName) {
        switch (tabName) {
            case 'dashboard':
                await loadDashboardData();
                break;
            case 'songs':
                await loadSongsData();
                break;
            case 'users':
                await loadUsersData();
                break;
            case 'system':
                await loadSystemData();
                break;
        }
    }

    // --- 4. ÎåÄÏãúÎ≥¥Îìú Í∏∞Îä• ---

    /** ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎî© */
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/admin/dashboard', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®');
            }
            
            const data = await response.json();
            console.log('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞:', data);
            
            // ÌÜµÍ≥Ñ Ïπ¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
            updateStatsCards(data.overview);
            
            // Ï∞®Ìä∏ ÏÉùÏÑ±
            createGenreChart(data.genreStats);
            createUserChart(data.userStats);
            
            // ÏµúÍ∑º ÌôúÎèô ÏóÖÎç∞Ïù¥Ìä∏
            updateRecentActivity(data.recentSongs);
            
        } catch (error) {
            console.error('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò:', error);
            showError('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    }

    /** ÌÜµÍ≥Ñ Ïπ¥Îìú ÏóÖÎç∞Ïù¥Ìä∏ */
    function updateStatsCards(overview) {
        const elements = {
            'total-users': overview.totalUsers,
            'total-songs': overview.totalSongs,
            'total-playlists': overview.totalPlaylists,
            'public-songs': overview.publicSongs
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    }

    /** Ïû•Î•¥ Ï∞®Ìä∏ ÏÉùÏÑ± */
    function createGenreChart(genreStats) {
        const ctx = document.getElementById('genre-chart');
        if (!ctx) return;
        
        // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
        if (genreChart) {
            genreChart.destroy();
        }
        
        const colors = [
            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', 
            '#9b59b6', '#1abc9c', '#34495e', '#e67e22'
        ];
        
        genreChart = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: genreStats.map(stat => stat.genre),
                datasets: [{
                    data: genreStats.map(stat => stat.count),
                    backgroundColor: colors.slice(0, genreStats.length),
                    borderColor: '#2c2c2c',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#e8f4fd'
                        }
                    }
                }
            }
        });
    }

    /** ÏÇ¨Ïö©Ïûê ÌôúÎèô Ï∞®Ìä∏ ÏÉùÏÑ± */
    function createUserChart(userStats) {
        const ctx = document.getElementById('user-chart');
        if (!ctx) return;
        
        // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
        if (userChart) {
            userChart.destroy();
        }
        
        // ÏÉÅÏúÑ 5Î™ÖÎßå ÌëúÏãú
        const topUsers = userStats.slice(0, 5);
        
        userChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: topUsers.map(user => user.username),
                datasets: [{
                    label: 'Songs Uploaded',
                    data: topUsers.map(user => user.songCount),
                    backgroundColor: 'rgba(52, 152, 219, 0.8)',
                    borderColor: '#3498db',
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#e8f4fd'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#e8f4fd'
                        },
                        grid: {
                            color: '#555'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#e8f4fd'
                        },
                        grid: {
                            color: '#555'
                        }
                    }
                }
            }
        });
    }

    /** ÏµúÍ∑º ÌôúÎèô ÏóÖÎç∞Ïù¥Ìä∏ */
    function updateRecentActivity(recentSongs) {
        const activityList = document.getElementById('recent-songs-list');
        if (!activityList) return;
        
        if (recentSongs.length === 0) {
            activityList.innerHTML = `
                <div class="empty-state">
                    <h4>No Recent Activity</h4>
                    <p>No songs have been uploaded recently.</p>
                </div>
            `;
            return;
        }
        
        activityList.innerHTML = '';
        recentSongs.forEach(song => {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            
            const timeAgo = getTimeAgo(new Date(song.createdAt));
            
            activityItem.innerHTML = `
                <div class="activity-icon">üéµ</div>
                <div class="activity-content">
                    <div class="activity-title">${song.title}</div>
                    <div class="activity-meta">
                        <span>Artist: ${song.artist || 'N/A'}</span>
                        <span>Genre: ${song.genre || 'N/A'}</span>
                        <span>Uploader: ${song.uploader}</span>
                        <span class="activity-badge ${song.isPublic ? 'public' : 'private'}">
                            ${song.isPublic ? 'Public' : 'Private'}
                        </span>
                    </div>
                </div>
                <div class="activity-time">${timeAgo}</div>
            `;
            
            activityList.appendChild(activityItem);
        });
    }

    // --- 5. ÎÖ∏Îûò Í¥ÄÎ¶¨ Í∏∞Îä• ---

    /** ÎÖ∏Îûò Îç∞Ïù¥ÌÑ∞ Î°úÎî© */
    async function loadSongsData() {
        try {
            const response = await fetch('/api/songs/admin', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('ÎÖ∏Îûò Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®');
            }
            
            allSongs = await response.json();
            filteredSongs = [...allSongs];
            renderSongs();
            updateSongStats();
            
        } catch (error) {
            console.error('ÎÖ∏Îûò Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò:', error);
            showError('ÎÖ∏Îûò Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    }

    /** ÎÖ∏Îûò Î™©Î°ù Î†åÎçîÎßÅ */
    function renderSongs() {
        const songListElement = document.getElementById('song-management-list');
        if (!songListElement) return;
        
        if (filteredSongs.length === 0) {
            songListElement.innerHTML = '<li style="text-align: center; color: #bbb; padding: 40px;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</li>';
            return;
        }

        songListElement.innerHTML = '';
        filteredSongs.forEach(song => {
            const li = document.createElement('li');
            li.innerHTML = `
                <input type="checkbox" class="song-checkbox" data-song-id="${song.id}">
                <div class="song-info">
                    <div class="song-details">
                        <div class="song-title">${song.title}</div>
                        <div class="song-meta">
                            <span>ÏïÑÌã∞Ïä§Ìä∏: ${song.artist || 'N/A'}</span>
                            <span>Ïû•Î•¥: ${song.genre || 'N/A'}</span>
                            <span>Î∞úÎß§Ïùº: ${song.date || 'N/A'}</span>
                            <span class="privacy-badge ${song.isPublic ? 'public' : 'private'}">${song.isPublic ? 'Í≥µÍ∞ú' : 'ÎπÑÍ≥µÍ∞ú'}</span>
                            ${song.User ? `<span>ÏóÖÎ°úÎçî: ${song.User.username}</span>` : ''}
                        </div>
                    </div>
                    <div class="song-actions">
                        <button class="btn-edit" data-song-id="${song.id}">ÏàòÏ†ï</button>
                        <button class="btn-delete" data-song-id="${song.id}">ÏÇ≠Ï†ú</button>
                    </div>
                </div>
            `;
            songListElement.appendChild(li);
        });
    }

    /** ÎÖ∏Îûò ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ */
    function updateSongStats() {
        const totalSongsElement = document.getElementById('total-songs-count');
        const selectedCountElement = document.getElementById('selected-count');
        
        if (totalSongsElement) {
            totalSongsElement.textContent = `Ï¥ù ÎÖ∏Îûò: ${filteredSongs.length}`;
        }
        
        if (selectedCountElement) {
            selectedCountElement.textContent = `ÏÑ†ÌÉùÎê®: ${selectedSongs.size}`;
        }
        
        // ÎåÄÎüâ ÏûëÏóÖ Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const bulkPublicBtn = document.getElementById('bulk-public-btn');
        const bulkPrivateBtn = document.getElementById('bulk-private-btn');
        
        const hasSelection = selectedSongs.size > 0;
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = !hasSelection;
        if (bulkPublicBtn) bulkPublicBtn.disabled = !hasSelection;
        if (bulkPrivateBtn) bulkPrivateBtn.disabled = !hasSelection;
    }

    // --- 6. ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ Í∏∞Îä• ---

    /** ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎî© */
    async function loadUsersData() {
        try {
            const response = await fetch('/api/admin/users', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®');
            }
            
            const users = await response.json();
            renderUsers(users);
            updateUserStats(users);
            
        } catch (error) {
            console.error('ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò:', error);
            showError('ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    }

    /** ÏÇ¨Ïö©Ïûê Î™©Î°ù Î†åÎçîÎßÅ */
    function renderUsers(users) {
        const usersListElement = document.getElementById('users-list');
        if (!usersListElement) return;
        
        if (users.length === 0) {
            usersListElement.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <h3>ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                        <p>ÏïÑÏßÅ Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    </td>
                </tr>
            `;
            return;
        }

        usersListElement.innerHTML = '';
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id}</td>
                <td>
                    <div class="user-info-cell">
                        <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <div class="user-details">
                            <div class="user-name">${user.username}</div>
                            <div class="user-id">ID: ${user.id}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="role-badge ${user.isAdmin ? 'admin' : 'user'}">
                        ${user.isAdmin ? 'Admin' : 'User'}
                    </span>
                </td>
                <td>
                    <span class="song-count">${user.songCount} songs</span>
                </td>
                <td>
                    <span class="join-date">${formatDate(user.createdAt)}</span>
                </td>
                <td>
                    <div class="user-actions">
                        <select class="role-select" data-user-id="${user.id}" data-current-role="${user.isAdmin}">
                            <option value="false" ${!user.isAdmin ? 'selected' : ''}>User</option>
                            <option value="true" ${user.isAdmin ? 'selected' : ''}>Admin</option>
                        </select>
                        <button class="btn-action btn-delete-user" data-user-id="${user.id}" data-username="${user.username}">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </td>
            `;
            usersListElement.appendChild(row);
        });
    }

    /** ÏÇ¨Ïö©Ïûê ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ */
    function updateUserStats(users) {
        const totalUsersElement = document.getElementById('total-users-count');
        const adminCountElement = document.getElementById('admin-count');
        
        if (totalUsersElement) {
            totalUsersElement.textContent = `Total: ${users.length}`;
        }
        
        if (adminCountElement) {
            const adminCount = users.filter(user => user.isAdmin).length;
            adminCountElement.textContent = `Admins: ${adminCount}`;
        }
    }

    // --- 7. ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ Í∏∞Îä• ---

    /** ÏãúÏä§ÌÖú Îç∞Ïù¥ÌÑ∞ Î°úÎî© */
    async function loadSystemData() {
        try {
            await loadSystemStatus();
        } catch (error) {
            console.error('ÏãúÏä§ÌÖú Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò:', error);
            showError('ÏãúÏä§ÌÖú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    }

    /** ÏãúÏä§ÌÖú ÏÉÅÌÉú Î°úÎî© */
    async function loadSystemStatus() {
        try {
            const response = await fetch('/api/admin/system-status', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('ÏãúÏä§ÌÖú ÏÉÅÌÉú Î°úÎî© Ïã§Ìå®');
            }
            
            const data = await response.json();
            updateSystemStatus(data);
            
        } catch (error) {
            console.error('ÏãúÏä§ÌÖú ÏÉÅÌÉú Î°úÎî© Ïò§Î•ò:', error);
            showError('ÏãúÏä§ÌÖú ÏÉÅÌÉúÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    }

    /** ÏãúÏä§ÌÖú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ */
    function updateSystemStatus(data) {
        const elements = {
            'server-uptime': formatUptime(data.server.uptime),
            'memory-usage': `${data.memory.usagePercent}% (${formatBytes(data.memory.used)} / ${formatBytes(data.memory.total)})`,
            'database-size': data.database.sizeFormatted,
            'node-version': data.server.nodeVersion
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    }

    // --- 8. Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò ---

    /** ÏãúÍ∞Ñ Í≤ΩÍ≥º Í≥ÑÏÇ∞ */
    function getTimeAgo(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) {
            return 'Just now';
        } else if (diffInSeconds < 3600) {
            const minutes = Math.floor(diffInSeconds / 60);
            return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else if (diffInSeconds < 86400) {
            const hours = Math.floor(diffInSeconds / 3600);
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        } else {
            const days = Math.floor(diffInSeconds / 86400);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }
    }

    /** ÏóÖÌÉÄÏûÑ Ìè¨Îß∑ÌåÖ */
    function formatUptime(seconds) {
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        if (days > 0) {
            return `${days}d ${hours}h ${minutes}m`;
        } else if (hours > 0) {
            return `${hours}h ${minutes}m`;
        } else {
            return `${minutes}m`;
        }
    }

    /** Î∞îÏù¥Ìä∏ Ìè¨Îß∑ÌåÖ */
    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    /** ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ */
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    /** ÏóêÎü¨ ÌëúÏãú */
    function showError(message) {
        const container = document.querySelector('.admin-main');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.style.cssText = `
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        `;
        errorDiv.textContent = message;
        container.insertBefore(errorDiv, container.firstChild);
        
        // 5Ï¥à ÌõÑ ÏóêÎü¨ Î©îÏãúÏßÄ Ï†úÍ±∞
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }

    // --- 9. Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ---

    /** ÌÉ≠ Î©îÎâ¥ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ */
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const tabName = item.dataset.tab;
            if (tabName) {
                switchTab(tabName);
            }
        });
    });

    /** Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ */
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
    }

    // ÎÖ∏Îûò Í¥ÄÎ¶¨ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎì§
    const songSearchInput = document.getElementById('song-search-input');
    const genreFilter = document.getElementById('genre-filter');
    const privacyFilter = document.getElementById('privacy-filter');
    const searchSongsBtn = document.getElementById('search-songs-btn');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const selectAllBtn = document.getElementById('select-all-btn');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const bulkPublicBtn = document.getElementById('bulk-public-btn');
    const bulkPrivateBtn = document.getElementById('bulk-private-btn');

    // Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ Ïù¥Î≤§Ìä∏
    if (searchSongsBtn) {
        searchSongsBtn.addEventListener('click', () => {
            // Í≤ÄÏÉâ Î°úÏßÅ Íµ¨ÌòÑ
            console.log('Í≤ÄÏÉâ Ïã§Ìñâ');
        });
    }

    if (songSearchInput) {
        songSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                // Í≤ÄÏÉâ Î°úÏßÅ Íµ¨ÌòÑ
                console.log('ÏóîÌÑ∞ÌÇ§ Í≤ÄÏÉâ');
            }
        });
    }

    if (genreFilter) {
        genreFilter.addEventListener('change', () => {
            // ÌïÑÌÑ∞ Î°úÏßÅ Íµ¨ÌòÑ
            console.log('Ïû•Î•¥ ÌïÑÌÑ∞ Î≥ÄÍ≤Ω');
        });
    }

    if (privacyFilter) {
        privacyFilter.addEventListener('change', () => {
            // ÌïÑÌÑ∞ Î°úÏßÅ Íµ¨ÌòÑ
            console.log('Í≥µÍ∞ú ÏÑ§Ï†ï ÌïÑÌÑ∞ Î≥ÄÍ≤Ω');
        });
    }

    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
            // ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî Î°úÏßÅ Íµ¨ÌòÑ
            console.log('ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî');
        });
    }

    // ÎåÄÎüâ ÏûëÏóÖ Ïù¥Î≤§Ìä∏
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => {
            // Ï†ÑÏ≤¥ ÏÑ†ÌÉù Î°úÏßÅ Íµ¨ÌòÑ
            console.log('Ï†ÑÏ≤¥ ÏÑ†ÌÉù');
        });
    }

    if (bulkDeleteBtn) {
        bulkDeleteBtn.addEventListener('click', () => {
            // ÎåÄÎüâ ÏÇ≠Ï†ú Î°úÏßÅ Íµ¨ÌòÑ
            console.log('ÎåÄÎüâ ÏÇ≠Ï†ú');
        });
    }

    if (bulkPublicBtn) {
        bulkPublicBtn.addEventListener('click', () => {
            // ÎåÄÎüâ Í≥µÍ∞ú Î°úÏßÅ Íµ¨ÌòÑ
            console.log('ÎåÄÎüâ Í≥µÍ∞ú');
        });
    }

    if (bulkPrivateBtn) {
        bulkPrivateBtn.addEventListener('click', () => {
            // ÎåÄÎüâ ÎπÑÍ≥µÍ∞ú Î°úÏßÅ Íµ¨ÌòÑ
            console.log('ÎåÄÎüâ ÎπÑÍ≥µÍ∞ú');
        });
    }

    // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
    document.addEventListener('change', (event) => {
        if (event.target.classList.contains('song-checkbox')) {
            const songId = parseInt(event.target.dataset.songId);
            if (event.target.checked) {
                selectedSongs.add(songId);
            } else {
                selectedSongs.delete(songId);
            }
            updateSongStats();
        }
    });

    // ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ Ïù¥Î≤§Ìä∏
    document.addEventListener('change', (event) => {
        if (event.target.classList.contains('role-select')) {
            const userId = event.target.dataset.userId;
            const currentRole = event.target.dataset.currentRole;
            const newRole = event.target.value;
            
            if (currentRole !== newRole) {
                // Í∂åÌïú Î≥ÄÍ≤Ω Î°úÏßÅ Íµ¨ÌòÑ
                console.log('ÏÇ¨Ïö©Ïûê Í∂åÌïú Î≥ÄÍ≤Ω:', userId, newRole);
            }
        }
    });

    document.addEventListener('click', (event) => {
        if (event.target.classList.contains('btn-delete-user')) {
            const userId = event.target.dataset.userId;
            const username = event.target.dataset.username;
            
            if (confirm(`Ï†ïÎßêÎ°ú "${username}" ÏÇ¨Ïö©ÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                // ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú Î°úÏßÅ Íµ¨ÌòÑ
                console.log('ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú:', userId);
            }
        }
    });

    // ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ Ïù¥Î≤§Ìä∏
    const createBackupBtn = document.getElementById('create-backup-btn');
    const refreshStatusBtn = document.getElementById('refresh-status-btn');
    const loadLogsBtn = document.getElementById('load-logs-btn');
    const clearLogsBtn = document.getElementById('clear-logs-btn');

    if (createBackupBtn) {
        createBackupBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/admin/backup', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Î∞±ÏóÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
                } else {
                    throw new Error('Î∞±ÏóÖ Ïã§Ìå®');
                }
            } catch (error) {
                console.error('Î∞±ÏóÖ Ïò§Î•ò:', error);
                alert('Î∞±ÏóÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        });
    }

    if (refreshStatusBtn) {
        refreshStatusBtn.addEventListener('click', loadSystemStatus);
    }

    if (loadLogsBtn) {
        loadLogsBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/admin/logs', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Î°úÍ∑∏ ÌëúÏãú Î°úÏßÅ Íµ¨ÌòÑ
                    console.log('Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞:', data);
                } else {
                    throw new Error('Î°úÍ∑∏ Î°úÎî© Ïã§Ìå®');
                }
            } catch (error) {
                console.error('Î°úÍ∑∏ Î°úÎî© Ïò§Î•ò:', error);
                alert('Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        });
    }

    if (clearLogsBtn) {
        clearLogsBtn.addEventListener('click', () => {
            const logsList = document.getElementById('logs-list');
            if (logsList) {
                logsList.innerHTML = '<div class="empty-state"><h4>Logs Cleared</h4><p>Click "Load Logs" to view system logs.</p></div>';
            }
        });
    }

    // --- 10. Ï¥àÍ∏∞ Ïã§Ìñâ ---
    checkAuthStatus();
    
    // ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎî©
    loadTabData('dashboard');
    
    // 30Ï¥àÎßàÎã§ ÏãúÏä§ÌÖú ÏÉÅÌÉú ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® (ÏãúÏä§ÌÖú ÌÉ≠Ïù¥ ÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞ÏóêÎßå)
    systemStatusInterval = setInterval(() => {
        if (currentTab === 'system') {
            loadSystemStatus();
        }
    }, 30000);
    
    // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ïù∏ÌÑ∞Î≤å Ï†ïÎ¶¨
    window.addEventListener('beforeunload', () => {
        if (systemStatusInterval) {
            clearInterval(systemStatusInterval);
        }
    });
});
